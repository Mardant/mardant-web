<!-- views/carrito.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Carrito - Mardant</title>
  <!-- favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <link rel="stylesheet" href="../css/estilos.css">
</head>
<body>
  <div class="carrito-container">
    <h1>üõí Mi Carrito</h1>
    <div id="lista-carrito"></div>
    <div class="total" id="total-carrito">Total: S/. 0.00</div>
    <div class="finalizar">
      <a href="#" id="finalizar-compra" class="boton">‚úÖ Finalizar compra por WhatsApp</a>
    </div>
  </div>

  <div class="volver-inicio">
    <a href="./inicio.html">üè† Volver al inicio</a>
  </div>

  <script type="module">
    import { actualizarCarritoUI } from '../js/carrito-utils.js';

    const contenedor = document.getElementById('lista-carrito');
    const totalSpan = document.getElementById('total-carrito');

    function waCleanText(str){
      // Quita caracteres invisibles/problem√°ticos
      str = String(str || '')
        .replace(/\u00A0/g, ' ')   // NBSP
        .replace(/\u200B/g, '')    // zero-width space
        .replace(/\uFEFF/g, '')    // BOM
        .replace(/\r\n/g, '\n');

      // Quita s√≠mbolos/emojis que terminan como ‚ÄúÔøΩÔøΩ‚Äù en algunos WhatsApp
      // (mantiene espa√±ol: tildes, √±, ¬ø?, etc.)
      str = str.replace(/[^\x09\x0A\x0D\x20-\x7E\u00A1-\u00FF]/g, '');

      // Limpia espacios extra
      str = str.replace(/[ \t]+\n/g, '\n').replace(/\n{3,}/g, '\n\n');

      return str.trim();
    }

    function renderCarrito() {
      const carritoLocal = JSON.parse(localStorage.getItem('carritoMardant') || '[]');

      contenedor.innerHTML = '';
      const total = carritoLocal.reduce((sum, item) => sum + item.precio, 0);

      carritoLocal.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'carrito-item';
        div.innerHTML = `
          <img src="${item.imagen}" alt="${item.nombre}">
          <div class="carrito-info">
            <div class="nombre">${item.nombre}</div>
            <div class="precio">S/. ${item.precio.toFixed(2)}</div>
          </div>
          <button class="eliminar" data-index="${index}">‚úï</button>
        `;
        contenedor.appendChild(div);
      });

      totalSpan.textContent = `Total: S/. ${total.toFixed(2)}`;
    }

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('eliminar')) {
        const index = Number(e.target.dataset.index);
        const carritoLocal = JSON.parse(localStorage.getItem('carritoMardant') || '[]');
        carritoLocal.splice(index, 1);
        localStorage.setItem('carritoMardant', JSON.stringify(carritoLocal));

        renderCarrito();
        actualizarCarritoUI();
      }
    });

    document.getElementById('finalizar-compra').addEventListener('click', (e) => {
      e.preventDefault();

      const cart = JSON.parse(localStorage.getItem('carritoMardant') || '[]');
      if (!cart.length) return;

      // Agrupar por id (si existe) o por nombre
      const groups = new Map();
      for (const item of cart) {
        const key = (item.id && String(item.id).trim())
          ? `id:${String(item.id).trim()}`
          : `name:${item.nombre}`;

        const g = groups.get(key) || { ...item, qty: 0 };
        g.qty += 1;
        groups.set(key, g);
      }

      const origin = location.origin;
      const lines = [];
      let total = 0;

      let i = 1;
      for (const g of groups.values()) {
        const unit = Number(g.precio) || 0;
        const sub  = unit * g.qty;
        total += sub;

        lines.push(
          `${i}) ${g.qty} x ${g.nombre} ‚Äî S/. ${unit.toFixed(2)} c/u ‚Äî Subtotal: S/. ${sub.toFixed(2)}`
        );

        // Link detalle solo si hay id
        if (g.id && String(g.id).trim()) {
          const link = `${origin}/views/producto.html?id=${encodeURIComponent(String(g.id).trim())}`;
          lines.push(`   ${link}`);
        }

        i++;
      }

      const mensaje = [
        '¬°Hola! Quiero hacer un pedido en Mardant Per√∫.',
        '',
        'Mi pedido:',
        ...lines,
        '',
        `TOTAL: S/. ${total.toFixed(2)}`,
        '',
        'Tipo de entrega: ¬øDelivery o recojo en punto de entrega gratuito en Lima?'
      ].join('\n');

      const clean = waCleanText(mensaje);
      const wa = `https://wa.me/51985135331?text=${encodeURIComponent(clean)}`;
      window.open(wa, '_blank');
    });

    renderCarrito();
  </script>

  <!-- Tracking (FB Pixel + GA4 + eventos) -->
  <script type="module" src="../js/tracking.js"></script>
</body>
</html>
